<!DOCTYPE html>
<html>
<head><title>getUserMedia</title></head>
<body>
<video autoplay></video>

<script src="pusher.js"></script>
<script src="js/simplepeer.js"></script>
<script>

  var guid = (function() {
    function s4() {
      return Math.floor((1 + Math.random()) * 0x10000)
          .toString(16)
          .substring(1);
    }
    return function() {
      return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
          s4() + '-' + s4() + s4() + s4();
    };
  })();

  var currentUser = {
    name: 'initiator',
    id: guid(),
    stream: undefined
  };
  Pusher.logToConsole = true;



  navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
  var constraints = { audio: false, video: true };
  var video = document.querySelector("video");
  function successCallback(stream) {
    console.log('stream success callback');

    currentUser.stream = stream;
    // setting up pusher
    var pusher = new Pusher('5e613cf066db77ef9bd6', {
      authEndpoint: 'auth.php',
      auth: {
        params: currentUser
      },
      cluster: "eu"
    });
    var channelName = 'presence-interfon';
    // set channel
    var channel = pusher.subscribe(channelName);
    var peers = {};

    function lookForPeers() {
      console.log('lookForPeers');
      for (var userId in channel.members.members) {
        if (userId != currentUser.id) {
          var member = channel.members.members[userId];

          peers[userId] = initiateConnection(userId, member.name)
        }
      }
    }

    function initiateConnection(peerUserId, peerUserName) {
      return setupPeer(peerUserId, peerUserName, true);
    };

    function setupPeer(peerUserId, peerUserName, initiator) {
      var peer = new SimplePeer({ initiator: initiator, stream: currentUser.stream, trickle: false });

      peer.on('signal', function (data) {
        channel.trigger('client-signal-' + peerUserId, {
          userId: currentUser.id, userName: currentUser.name, data: data
        });
      });

      peer.on('stream', function(stream) {
        console.log('on stream');
        var video = document.querySelector("video");
        video.src = window.URL.createObjectURL(stream);
      });
//      peer.on('close', function() { close(peerUserId, peerUserName) });
//      $(window).on('beforeunload', function() { close(peerUserId, peerUserName) });

      peer.on('message', function (data) {
        console.log(data);
        /*if (data == '__SPEAKING__') {
          $('#remoteVideos video').hide();
          $("#remoteVideos video[data-user-id='" + peerUserId + "']").show();
        } else {
          appendMessage(peerUserName, data);
        }*/
      });

      return peer;
    }

    channel.bind('pusher:subscription_succeeded', function() {
      console.log('Channel members:', channel.members);
      lookForPeers();
    });

    channel.bind('client-signal-' + currentUser.id, function(signal) {
      console.log('client-signal-' + currentUser.id);
      var peer = peers[signal.userId];

      if (peer === undefined) {
        peer = setupPeer(signal.userId, signal.userName, false);
      }

      peer.on('ready', function() {
        alert('connected');
//        appendMessage(signal.userName, '<em>Connected</em>');
      });
      peer.signal(signal.data)
    });


//    var peer = new SimplePeer({ initiator: true, stream: currentUser.stream, channelName: channelName });
//    console.log(peer);
//    peer.on('signal', function (data) {
//      console.log('on signal');
//      channel.trigger('client-signal-' + currentUser.id, { userId: currentUser.id, data: data });
//    });
//
//    peer.on('ready', function () {
//      console.log('on ready');
//      peer.send('hey peer, how is it going?')
//    });
//
//    peer.on('stream', function(stream) {
//      console.log('on stream');
//      var video = document.querySelector("video");
//      video.src = window.URL.createObjectURL(stream);
//    });
//
//    peer.send(stream);
  }
  function errorCallback(error){
    console.log("getUserMedia error: ", error);
  }



  navigator.getUserMedia(constraints, successCallback, errorCallback);

/*
* this new stuff
*/

</script>
</body>
</html>