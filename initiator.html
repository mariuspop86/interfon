<!DOCTYPE html>
<html>
<head><title>getUserMedia</title></head>
<body>
<video autoplay></video>

<script src="pusher.js"></script>
<script src="js/simplepeer.js"></script>
<script src="js/hark.js"></script>
<script>

  var currentUser = {
    name: 'initiator',
    id: 1
  };
//  Pusher.logToConsole = true;
//
//  // setting up pusher
//  var pusher = new Pusher('5e613cf066db77ef9bd6', {
//    authEndpoint: 'auth.php',
//    auth: {
//      params: currentUser
//    },
//    cluster: "eu"
//  });
//  var channelName = 'presence-interfon';
//  // set channel
//  var channel = pusher.subscribe(channelName);
//
//  navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
//  var constraints = { audio: true, video: true };
//  var video = document.querySelector("video");
//  function successCallback(stream) {
//    console.log('stream success callback');
////    video.src = window.URL.createObjectURL(stream);
//    currentUser.stream = stream;
//
//    var peer = new SimplePeer({ initiator: true, stream: currentUser.stream, channelName: channelName });
//    console.log(peer);
//    peer.on('signal', function (data) {
//      console.log('on signal');
//      channel.trigger('client-signal-' + currentUser.id, { userId: currentUser.id, data: data });
//    });
//
//    peer.on('ready', function () {
//      console.log('on ready');
//      peer.send('hey peer, how is it going?')
//    });
//
//    peer.on('stream', function(stream) {
//      console.log('on stream');
//      var video = document.querySelector("video");
//      video.src = window.URL.createObjectURL(stream);
//    });
//
//    peer.send(stream);
//  }
//  function errorCallback(error){
//    console.log("getUserMedia error: ", error);
//  }
//
//
//  channel.bind('pusher:subscription_succeeded', function() {
//    console.log('Channel members:', channel.members);
//    navigator.getUserMedia(constraints, successCallback, errorCallback);
//  });

/*
* this new stuff
*/
  navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

  var mediaOptions = {
    audio: true,
    video: {
      mandatory: {
        minWidth: 1280,
        minHeight: 720
      }
    }
  };

  navigator.getUserMedia(mediaOptions, function(stream) {
    currentUser.stream = stream;
    var video = document.querySelector("video");
    video.src = window.URL.createObjectURL(stream);

    start();
  }, function() {});

  function start() {
    var pusher = new Pusher('5e613cf066db77ef9bd6', {
        authEndpoint: 'auth.php',
        auth: {
          params: currentUser
        },
        cluster: "eu"
      });

    var channel = pusher.subscribe('presence-interfon');
    var peers = {};

    function lookForPeers() {
      for (var userId in channel.members.members) {
        if (userId != currentUser.id) {
          var member = channel.members.members[userId];

          peers[userId] = initiateConnection(userId, member.name)
        }
      }
    }

    channel.bind('pusher:subscription_succeeded', lookForPeers);

    function gotRemoteVideo(userId, userName, stream) {
      console.log('gotRemoteVideo');
      var video = $("<video autoplay data-user-id='" + userId + "'/>");
      video[0].src = window.URL.createObjectURL(stream);
      $('#remoteVideos').append(video);

      var preview = $("<li data-user-id='" + userId + "'>");
      preview.append("<video autoplay/>");
      preview.append("<div class='name'>" + userName + "</div></li>")
      preview.find('video')[0].src = window.URL.createObjectURL(stream);

      $('#allVideos').append(preview);
    }

    function appendMessage(name, message) {
      $messages.append('<dt>' + name + '</dt>');
      $messages.append('<dd>' + message + '</dd>');
    }

    function close(userId, name) {
      var peer = peers[userId];
      if (peer) {
        peer.destroy();
        peers[userId] = undefined;
      }
      $("[data-user-id='" + userId + "']").remove();
      appendMessage(name, '<em>Disconnected</em>');
    }

    function setupPeer(peerUserId, peerUserName, initiator) {
      var peer = new SimplePeer({ initiator: initiator, stream: currentUser.stream, trickle: false });

      peer.on('signal', function (data) {
        channel.trigger('client-signal-' + peerUserId, {
          userId: currentUser.id, userName: currentUser.name, data: data
        });
      });

      peer.on('stream', function(stream) { gotRemoteVideo(peerUserId, peerUserName, stream) });
      peer.on('close', function() { close(peerUserId, peerUserName) });
      $(window).on('beforeunload', function() { close(peerUserId, peerUserName) });

      peer.on('message', function (data) {
        if (data == '__SPEAKING__') {
          $('#remoteVideos video').hide();
          $("#remoteVideos video[data-user-id='" + peerUserId + "']").show();
        } else {
          appendMessage(peerUserName, data);
        }
      });

      return peer;
    }

    function initiateConnection(peerUserId, peerUserName) {
      return setupPeer(peerUserId, peerUserName, true);
    };

    channel.bind('client-signal-' + currentUser.id, function(signal) {
      var peer = peers[signal.userId];

      if (peer === undefined) {
        peer = setupPeer(signal.userId, signal.userName, false);
      }

      peer.on('ready', function() {
        appendMessage(signal.userName, '<em>Connected</em>');
      });
      peer.signal(signal.data)
    });

    var speech = hark(currentUser.stream);

    speech.on('speaking', function() {
      for (var userId in peers) {
        var peer = peers[userId];
        peer.send('__SPEAKING__');
      }
    });

    $('#send-message').submit(function(e) {
      e.preventDefault();
      var $input = $(this).find('input'),
          message = $input.val();

      $input.val('');

      for (var userId in peers) {
        var peer = peers[userId];
        peer.send(message);
      }
      appendMessage(currentUser.name, message);
    });
  }

</script>
</body>
</html>